"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getSystemInfo = getSystemInfo;
exports.checkCrawleeVersion = checkCrawleeVersion;
exports.printOutdatedSdkWarning = printOutdatedSdkWarning;
const tslib_1 = require("tslib");
const node_os_1 = require("node:os");
const node_path_1 = require("node:path");
// @ts-ignore if we enable resolveJsonModule, we end up with `src` folder in `dist`
const package_json_1 = require("@crawlee/core/package.json");
// @ts-ignore if we enable resolveJsonModule, we end up with `src` folder in `dist`
const package_json_2 = require("apify-client/package.json");
const fs_extra_1 = require("fs-extra");
const semver_1 = tslib_1.__importDefault(require("semver"));
const consts_1 = require("@apify/consts");
const log_1 = tslib_1.__importDefault(require("@apify/log"));
// @ts-ignore if we enable resolveJsonModule, we end up with `src` folder in `dist`
const package_json_3 = require("./package.json");
/**
 * Gets info about system, node version and apify package version.
 * @internal
 */
function getSystemInfo() {
    return {
        apifyVersion: package_json_3.version,
        apifyClientVersion: package_json_2.version,
        crawleeVersion: package_json_1.version,
        osType: (0, node_os_1.type)(),
        nodeVersion: process.version,
    };
}
/**
 * @internal
 */
function checkCrawleeVersion() {
    const resolve = (name) => {
        try {
            return require.resolve(name);
        }
        catch {
            return name;
        }
    };
    const paths = [
        // when users install `crawlee` package, we need to check its core dependency
        (0, node_path_1.normalize)(`${process.cwd()}/node_modules/crawlee/node_modules/@crawlee/core/package.json`),
        // when users install `@crawlee/cheerio` or other crawler package, we need to check the dependency under basic crawler package
        (0, node_path_1.normalize)(`${process.cwd()}/node_modules/@crawlee/basic/node_modules/@crawlee/core/package.json`),
        // also check paths via `require.resolve` to support pnpm
        resolve('crawlee/package.json'),
        resolve('@crawlee/basic/package.json'),
    ];
    for (const path of paths) {
        // ignore unresolved paths or paths that are not in the project directory
        if (!(0, fs_extra_1.pathExistsSync)(path) || !path.startsWith(process.cwd())) {
            continue;
        }
        let version;
        try {
            version = (0, fs_extra_1.readJSONSync)(path).version;
        }
        catch {
            //
        }
        if (version != null && version !== package_json_1.version) {
            const details = `User installed version (${version}) found in ${path}.\nSDK uses ${package_json_1.version} from ${require.resolve('@crawlee/core')}`;
            throw new Error(`Detected incompatible Crawlee version used by the SDK. User installed ${version} but the SDK uses ${package_json_1.version}.\n\n${details}`);
        }
    }
}
/**
 * Prints a warning if this version of Apify SDK is outdated.
 * @ignore
 */
function printOutdatedSdkWarning() {
    if (process.env[consts_1.APIFY_ENV_VARS.DISABLE_OUTDATED_WARNING])
        return;
    const latestApifyVersion = process.env[consts_1.APIFY_ENV_VARS.SDK_LATEST_VERSION];
    if (!latestApifyVersion || !semver_1.default.lt(package_json_3.version, latestApifyVersion))
        return;
    log_1.default.warning(`You are using an outdated version (${package_json_3.version}) of Apify SDK. We recommend you to update to the latest version (${latestApifyVersion}).
         Read more about Apify SDK versioning at: https://help.apify.com/en/articles/3184510-updates-and-versioning-of-apify-sdk`);
}
//# sourceMappingURL=utils.js.map